<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Portal Projects ‚Äî –î–æ—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { display: flex; min-height: 100vh; margin: 0; }
    .sidebar { width: 250px; background-color: #f8f9fa; padding: 20px; }
    .main-content { flex-grow: 1; padding: 20px; }
    .kanban-board { display: flex; gap: 20px; overflow-x: auto; }
    .kanban-column { background: #f1f3f5; padding: 10px; border-radius: 8px; min-width: 300px; flex-shrink: 0; }
    .kanban-card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; color: inherit; display: block; }
    .kanban-card.dragging { opacity: 0.5; }
    .column-header { display: flex; justify-content: space-between; align-items: center; }
    .progress { height: 8px; margin-top: 10px; }
  </style>
</head>
<body>
<div class="sidebar">
  <h4>–ú–µ–Ω—é</h4>
  <ul class="nav flex-column">
    <li class="nav-item"><a class="nav-link" href="#">–ü—Ä–æ–µ–∫—Ç—ã</a></li>
  </ul>
</div>
<div class="main-content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìã –î–æ—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</h1>
    <div>
      <button class="btn btn-primary me-2" onclick="openCreateModal()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      <input type="text" id="filterInput" class="form-control d-inline-block" placeholder="–§–∏–ª—å—Ç—Ä" style="width: 200px;">
    </div>
  </div>
  <div class="kanban-board" id="kanbanBoard"></div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content"><form id="createForm">
    <div class="modal-header"><h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="text" class="form-control mb-2" id="projectName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required>
      <input type="text" class="form-control mb-2" id="managerName" placeholder="–ú–µ–Ω–µ–¥–∂–µ—Ä" required>
      <input type="text" class="form-control mb-2" id="clientName" placeholder="–ö–ª–∏–µ–Ω—Ç" required>
      <select class="form-control" id="projectStatus">
        <option>–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ</option>
        <option>–í —Ä–∞–±–æ—Ç–µ</option>
        <option>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
        <option>–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ</option>
      </select>
    </div>
    <div class="modal-footer"><button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button></div>
  </form></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const statuses = ["–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ", "–í —Ä–∞–±–æ—Ç–µ", "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ", "–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ"];
const statusProgress = { "–ù–µ—Ä–∞–∑–æ–±—Ä–∞–Ω–Ω–æ–µ": 0, "–í —Ä–∞–±–æ—Ç–µ": 50, "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ": 100, "–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ": 10 };

async function fetchProjects() {
  const res = await fetch("/projects");
  return await res.json();
}

async function renderBoard() {
  const board = document.getElementById("kanbanBoard");
  board.innerHTML = "";
  const projects = await fetchProjects();
  statuses.forEach(status => {
    const col = document.createElement("div");
    col.className = "kanban-column";
    const header = document.createElement("div");
    header.className = "column-header";
    header.innerHTML = `<h5>${status}</h5><span class="badge bg-primary">${projects.filter(p => p.status === status).length}</span>`;
    col.appendChild(header);

    projects.filter(p => p.status === status).forEach(project => {
      const card = document.createElement("a");
      card.href = `project.html?id=${project.id}`;
      card.className = "kanban-card";
      card.innerHTML = `<span class="badge bg-secondary">${project.status}</span><br><strong>${project.title}</strong><br>${project.manager}<br>${project.client}
      <div class="progress"><div class="progress-bar" style="width:${statusProgress[project.status] || 0}%"></div></div>`;
      col.appendChild(card);
    });

    board.appendChild(col);
  });
}

function openCreateModal() {
  new bootstrap.Modal(document.getElementById("createModal")).show();
}

document.getElementById("createForm").addEventListener("submit", async e => {
  e.preventDefault();
  const payload = {
    title: document.getElementById("projectName").value,
    manager: document.getElementById("managerName").value,
    client: document.getElementById("clientName").value,
    status: document.getElementById("projectStatus").value
  };
  await fetch("/projects", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  bootstrap.Modal.getInstance(document.getElementById("createModal")).hide();
  renderBoard();
});

document.getElementById("filterInput").addEventListener("input", function() {
  const search = this.value.toLowerCase();
  document.querySelectorAll(".kanban-card").forEach(card => {
    card.style.display = card.innerText.toLowerCase().includes(search) ? "" : "none";
  });
});

renderBoard();
</script>
</body>
</html>
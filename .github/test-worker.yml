name: 🔁 Worker Smoke Test

on:
  push:
    paths:
      - 'clientservice/worker/**'
  pull_request:
    paths:
      - 'clientservice/worker/**'

jobs:
  test-worker:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: client_user
          POSTGRES_PASSWORD: client_pass
          POSTGRES_DB: client_service
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3

      - name: ⚙️ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: 🧰 Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 🐳 Build Docker (worker only)
        run: |
          docker compose -f docker-compose.yml build worker
          docker compose -f docker-compose.yml up -d worker kafka crm

      - name: ⏳ Wait for services to be ready
        run: sleep 10

      - name: ✅ Run test_worker.sh
        run: |
          chmod +x clientservice/worker/test_worker.sh
          clientservice/worker/test_worker.sh

      - name: 🧹 Shutdown
        run: docker compose -f docker-compose.yml down